<!-- Desktop Carousel: Always show 3 photos -->
<div class="desktop-carousel-container d-none d-md-block position-relative">
  <div id="featuredPhotosCarousel" class="featured-photos-desktop">
    <div class="photo-track" style="transform: translateX(0%);">
      <% if photos.size >= 3 %>
        <!-- Show all photos plus duplicates for seamless looping -->
        <% (photos.to_a * 2).each_with_index do |photo, index| %>
          <div class="photo-slide" data-slide="<%= index %>">
            <article class="card h-100 shadow-sm featured-photo-card" itemscope itemtype="https://schema.org/Photograph">
              <% if photo.image.attached? %>
                <div class="photo-frame">
                  <%= link_to photo_path(photo), 
                      data: { 
                        bs_toggle: "modal", 
                        bs_target: "#photoModal",
                        photo_id: photo.id,
                        photo_url: cl_image_path(photo.image.key, width: 1200, height: 800, crop: :fit, quality: :auto, fetch_format: :auto),
                        category: photo.category
                      } do %>
                    <%= cl_image_tag photo.image.key,
                        width: 400, height: 300, crop: :fill, quality: :auto, fetch_format: :auto,
                        class: "card-img-top featured-photo-image",
                        alt: "Featured photo from #{photo.category}",
                        itemprop: "image" %>
                  <% end %>
                </div>
              <% end %>
              <div class="card-body d-flex flex-column">
                <footer class="mt-auto text-center">
                  <%= link_to photos_path(category: photo.category), 
                      class: "btn btn-outline-primary btn-sm" do %>
                    <i class="fas fa-camera me-1"></i>
                    <%= photo.category %>
                  <% end %>
                </footer>
              </div>
            </article>
          </div>
        <% end %>
      <% else %>
        <!-- If less than 3 photos, just show them regularly -->
        <% photos.each_with_index do |photo, index| %>
          <div class="photo-slide" data-slide="<%= index %>">
            <article class="card h-100 shadow-sm featured-photo-card" itemscope itemtype="https://schema.org/Photograph">
              <% if photo.image.attached? %>
                <div class="photo-frame">
                  <%= link_to photo_path(photo), 
                      data: { 
                        bs_toggle: "modal", 
                        bs_target: "#photoModal",
                        photo_id: photo.id,
                        photo_url: cl_image_path(photo.image.key, width: 1200, height: 800, crop: :fit, quality: :auto, fetch_format: :auto),
                        category: photo.category
                      } do %>
                    <%= cl_image_tag photo.image.key,
                        width: 400, height: 300, crop: :fill, quality: :auto, fetch_format: :auto,
                        class: "card-img-top featured-photo-image",
                        alt: "Featured photo from #{photo.category}",
                        itemprop: "image" %>
                  <% end %>
                </div>
              <% end %>
              <div class="card-body d-flex flex-column">
                <footer class="mt-auto text-center">
                  <%= link_to photos_path(category: photo.category), 
                      class: "btn btn-outline-primary btn-sm" do %>
                    <i class="fas fa-camera me-1"></i>
                    <%= photo.category %>
                  <% end %>
                </footer>
              </div>
            </article>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
  
  <!-- Arrow Controls -->
  <% if photos.size > 1 %>
    <button class="carousel-arrow carousel-arrow-prev" id="prevArrow">
      <i class="fas fa-chevron-left"></i>
    </button>
    <button class="carousel-arrow carousel-arrow-next" id="nextArrow">
      <i class="fas fa-chevron-right"></i>
    </button>
  <% end %>
</div>

<!-- Mobile Carousel: 1 photo at a time, swipeable -->
<div id="featuredPhotosMobile" class="carousel slide d-md-none" data-bs-ride="false" data-bs-interval="false">
  <div class="carousel-inner">
    <% mobile_photos = photos.to_a.shuffle %>
    <% mobile_photos.each_with_index do |photo, index| %>
      <div class="carousel-item <%= 'active' if index == 0 %>">
        <div class="row justify-content-center">
          <div class="col-10" itemscope itemtype="https://schema.org/Photograph">
            <article class="card h-100 shadow-sm featured-photo-card">
              <% if photo.image.attached? %>
                <div class="photo-frame">
                  <%= link_to photo_path(photo), 
                      data: { 
                        bs_toggle: "modal", 
                        bs_target: "#photoModal",
                        photo_id: photo.id,
                        photo_url: cl_image_path(photo.image.key, width: 1200, height: 800, crop: :fit, quality: :auto, fetch_format: :auto),
                        category: photo.category
                      } do %>
                    <%= cl_image_tag photo.image.key,
                        width: 400, height: 300, crop: :fill, quality: :auto, fetch_format: :auto,
                        class: "card-img-top featured-photo-image",
                        alt: "Featured photo from #{photo.category}",
                        itemprop: "image" %>
                  <% end %>
                </div>
              <% end %>
              <div class="card-body d-flex flex-column">
                <footer class="mt-auto text-center">
                  <%= link_to photos_path(category: photo.category), 
                      class: "btn btn-outline-primary btn-sm" do %>
                    <i class="fas fa-camera me-1"></i>
                    <%= photo.category %>
                  <% end %>
                </footer>
              </div>
            </article>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  
  <!-- Swipe hint for mobile (no dots) -->
  <% if mobile_photos.size > 1 %>
    <div class="text-center mt-3 d-md-none">
      <small class="text-muted">
        <i class="fas fa-hand-pointer me-1"></i>
        Swipe left or right to see more
      </small>
    </div>
  <% end %>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      <div class="modal-body">
        <img id="modalPhotoImage" src="" alt="">
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle photo modal
  const photoModal = document.getElementById('photoModal');
  const modalImage = document.getElementById('modalPhotoImage');
  
  // Listen for modal trigger clicks
  document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#photoModal"]').forEach(function(trigger) {
    trigger.addEventListener('click', function(e) {
      e.preventDefault();
      const photoUrl = this.dataset.photoUrl;
      const category = this.dataset.category;
      
      modalImage.src = photoUrl;
      modalImage.alt = `Featured photo from ${category}`;
    });
  });

  // Desktop carousel functionality
  const desktopTrack = document.querySelector('.photo-track');
  const nextBtn = document.getElementById('nextArrow');
  const prevBtn = document.getElementById('prevArrow');
  
  if (desktopTrack && nextBtn && prevBtn) {
    const allSlides = document.querySelectorAll('.photo-slide');
    const totalSlides = allSlides.length;
    const originalPhotosCount = Math.floor(totalSlides / 2); // Since we duplicate photos
    let currentIndex = 0;
    
    function updateCarousel(instant = false) {
      const slideWidth = 33.333;
      const translateX = -(currentIndex * slideWidth);
      
      if (instant) {
        desktopTrack.style.transition = 'none';
        desktopTrack.style.transform = `translateX(${translateX}%)`;
        // Force reflow
        desktopTrack.offsetHeight;
        desktopTrack.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
      } else {
        desktopTrack.style.transform = `translateX(${translateX}%)`;
      }
    }
    
    nextBtn.addEventListener('click', function() {
      currentIndex++;
      updateCarousel();
      
      // Reset to beginning when we reach the duplicated section
      if (currentIndex >= originalPhotosCount) {
        setTimeout(() => {
          currentIndex = 0;
          updateCarousel(true);
        }, 400); // Wait for animation to complete
      }
    });
    
    prevBtn.addEventListener('click', function() {
      if (currentIndex <= 0) {
        // Jump to end of original photos instantly, then animate back one
        currentIndex = originalPhotosCount;
        updateCarousel(true);
        setTimeout(() => {
          currentIndex = originalPhotosCount - 1;
          updateCarousel();
        }, 50);
      } else {
        currentIndex--;
        updateCarousel();
      }
    });
  }

  // Enable touch/swipe for mobile carousel
  const mobileCarousel = document.getElementById('featuredPhotosMobile');
  if (mobileCarousel) {
    const carousel = new bootstrap.Carousel(mobileCarousel, {
      interval: false,
      touch: true
    });

    // Add swipe gesture support
    let startX = null;
    let startY = null;

    mobileCarousel.addEventListener('touchstart', function(e) {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    }, { passive: true });

    mobileCarousel.addEventListener('touchend', function(e) {
      if (!startX || !startY) return;

      const endX = e.changedTouches[0].clientX;
      const endY = e.changedTouches[0].clientY;

      const diffX = startX - endX;
      const diffY = startY - endY;

      // Only trigger if horizontal swipe is dominant and significant
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX > 0) {
          // Swiped left - go to next photo
          carousel.next();
        } else {
          // Swiped right - go to previous photo
          carousel.prev();
        }
      }

      startX = null;
      startY = null;
    }, { passive: true });
  }
});
</script>