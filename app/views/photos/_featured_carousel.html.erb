<!-- Desktop Carousel: Show 3 photos, slide one at a time -->
<div class="desktop-carousel-container d-none d-md-block position-relative">
  <div id="featuredPhotosCarousel" class="featured-photos-desktop">
    <div class="photo-track" style="transform: translateX(0%);">
      <% photos.each_with_index do |photo, index| %>
        <div class="photo-slide" data-slide="<%= index %>">
          <article class="card h-100 shadow-sm featured-photo-card" itemscope itemtype="https://schema.org/Photograph">
            <% if photo.image.attached? %>
              <div class="photo-frame">
                <%= link_to photo_path(photo), 
                    data: { 
                      bs_toggle: "modal", 
                      bs_target: "#photoModal",
                      photo_id: photo.id,
                      photo_url: cl_image_path(photo.image.key, width: 1200, height: 800, crop: :fit, quality: :auto, fetch_format: :auto),
                      category: photo.category
                    } do %>
                  <%= cl_image_tag photo.image.key,
                      width: 400, height: 300, crop: :fill, quality: :auto, fetch_format: :auto,
                      class: "card-img-top featured-photo-image",
                      alt: "Featured photo from #{photo.category}",
                      itemprop: "image" %>
                <% end %>
              </div>
            <% end %>
            <div class="card-body d-flex flex-column">
              <footer class="mt-auto text-center">
                <%= link_to photos_path(category: photo.category), 
                    class: "btn btn-outline-primary btn-sm" do %>
                  <i class="fas fa-camera me-1"></i>
                  <%= photo.category %>
                <% end %>
              </footer>
            </div>
          </article>
        </div>
      <% end %>
    </div>
  </div>
  
  <!-- Arrow Controls -->
  <% if photos.size > 1 %>
    <button class="carousel-arrow carousel-arrow-prev" id="prevArrow">
      <i class="fas fa-chevron-left"></i>
    </button>
    <button class="carousel-arrow carousel-arrow-next" id="nextArrow">
      <i class="fas fa-chevron-right"></i>
    </button>
  <% end %>
</div>

<!-- Mobile Carousel: 1 photo at a time, swipeable -->
<div id="featuredPhotosMobile" class="carousel slide d-md-none" data-bs-ride="false">
  <div class="carousel-inner">
    <% shuffled_photos = photos.shuffle %>
    <% shuffled_photos.each_with_index do |photo, index| %>
      <div class="carousel-item <%= 'active' if index == 0 %>">
        <div class="row justify-content-center">
          <div class="col-10" itemscope itemtype="https://schema.org/Photograph">
            <article class="card h-100 shadow-sm featured-photo-card">
              <% if photo.image.attached? %>
                <div class="photo-frame">
                  <%= link_to photo_path(photo), 
                      data: { 
                        bs_toggle: "modal", 
                        bs_target: "#photoModal",
                        photo_id: photo.id,
                        photo_url: cl_image_path(photo.image.key, width: 1200, height: 800, crop: :fit, quality: :auto, fetch_format: :auto),
                        category: photo.category
                      } do %>
                    <%= cl_image_tag photo.image.key,
                        width: 400, height: 300, crop: :fill, quality: :auto, fetch_format: :auto,
                        class: "card-img-top featured-photo-image",
                        alt: "Featured photo from #{photo.category}",
                        itemprop: "image" %>
                  <% end %>
                </div>
              <% end %>
              <div class="card-body d-flex flex-column">
                <footer class="mt-auto text-center">
                  <%= link_to photos_path(category: photo.category), 
                      class: "btn btn-outline-primary btn-sm" do %>
                    <i class="fas fa-camera me-1"></i>
                    <%= photo.category %>
                  <% end %>
                </footer>
              </div>
            </article>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  
  <!-- Swipe hint for mobile (no dots) -->
  <% if photos.size > 1 %>
    <div class="text-center mt-3 d-md-none">
      <small class="text-muted">
        <i class="fas fa-hand-pointer me-1"></i>
        Swipe left or right to see more
      </small>
    </div>
  <% end %>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body p-0 position-relative">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                data-bs-dismiss="modal" aria-label="Close" style="z-index: 1050;"></button>
        <div class="text-center">
          <img id="modalPhotoImage" src="" alt="" class="img-fluid rounded" 
               style="max-height: 80vh; border: 8px solid white;">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle photo modal
  const photoModal = document.getElementById('photoModal');
  const modalImage = document.getElementById('modalPhotoImage');
  
  // Listen for modal trigger clicks
  document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#photoModal"]').forEach(function(trigger) {
    trigger.addEventListener('click', function(e) {
      e.preventDefault();
      const photoUrl = this.dataset.photoUrl;
      const category = this.dataset.category;
      
      modalImage.src = photoUrl;
      modalImage.alt = `Featured photo from ${category}`;
    });
  });

  // Desktop carousel functionality
  const desktopTrack = document.querySelector('.photo-track');
  const nextBtn = document.getElementById('nextArrow');
  const prevBtn = document.getElementById('prevArrow');
  
  if (desktopTrack && nextBtn && prevBtn) {
    const totalPhotos = document.querySelectorAll('.photo-slide').length;
    let currentIndex = 0;
    
    function updateCarousel() {
      // Each slide is 33.333% wide, move by that amount
      const slideWidth = 33.333;
      const translateX = -(currentIndex * slideWidth);
      desktopTrack.style.transform = `translateX(${translateX}%)`;
    }
    
    nextBtn.addEventListener('click', function() {
      currentIndex = (currentIndex + 1) % totalPhotos; // Infinite scroll
      updateCarousel();
    });
    
    prevBtn.addEventListener('click', function() {
      currentIndex = (currentIndex - 1 + totalPhotos) % totalPhotos; // Infinite scroll
      updateCarousel();
    });
  }

  // Enable touch/swipe for mobile carousel
  const mobileCarousel = document.getElementById('featuredPhotosMobile');
  if (mobileCarousel) {
    const carousel = new bootstrap.Carousel(mobileCarousel, {
      interval: false,
      touch: true
    });

    // Add swipe gesture support
    let startX = null;
    let startY = null;

    mobileCarousel.addEventListener('touchstart', function(e) {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    }, { passive: true });

    mobileCarousel.addEventListener('touchend', function(e) {
      if (!startX || !startY) return;

      const endX = e.changedTouches[0].clientX;
      const endY = e.changedTouches[0].clientY;

      const diffX = startX - endX;
      const diffY = startY - endY;

      // Only trigger if horizontal swipe is dominant and significant
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX > 0) {
          // Swiped left - go to next photo
          carousel.next();
        } else {
          // Swiped right - go to previous photo
          carousel.prev();
        }
      }

      startX = null;
      startY = null;
    }, { passive: true });
  }
});
</script>